/*
dionysus - v0.0.0
git@github.com:Ermak-13/Dionysus.git
*/

window.Views=window.Views||{},function(a,b){_.mixin(_.str.exports()),_.str.include("Underscore.string","string");var c=function(){this.save=function(a,b){localStorage.setItem(a,b)},this.load=function(a){return localStorage.getItem(a)}},d=Backbone.View.extend({initialize:function(a){this.item=a},render:function(){var a=Mustache.render(this.template,this.getContext());return this.$el.html(a),this},getContext:function(){return this.item.toJSON()}}),e=Backbone.View.extend({initialize:function(a){this.items=a},render:function(){var a=this;return _.each(a.items.models,function(b){var c=new a.ItemView(b),d=c.render().$el;a.$el.append(d)}),this}}),f=Backbone.View.extend({tagName:"li",className:function(){return["widget",this.widgetName].join(" ")},render:function(){var a=Mustache.render(this.template,this.getContext());return this.$el.data("widget-name",this.widgetName),this.$el.html(a)},getContext:function(){return{}},resize:function(a,b){if(this.page){var c=this.page.gridster;c.resize_widget(this.$el,a,b)}},closeContent:function(){}}),g=f.extend({events:{"click .js-open-internal-page":"openInternalPage"},openInternalPage:function(){var a=this;return chrome.tabs.create({url:a.url}),!1}}),h=Backbone.View.extend({el:".gridster ul",enabledWidgets:{},settings:{widthCell:25,heightCell:25,widgets:{}},initialize:function(){var b=this;this.gridster=this.$el.gridster({avoid_overlapped_widgets:!0,widget_base_dimensions:[b.settings.widthCell,b.settings.heightCell],draggable:{stop:function(b){var c=$(b.target).closest(".widget"),d=c.data("widget-name"),e=c.attr("data-col"),f=c.attr("data-row"),g=JSON.stringify({x:e,y:f});a.storage.save(d,g)}}}).data("gridster")},addWidget:function(b,c,d){var e=new b,f=e.widgetName,g=a.storage.load(f);g=g?JSON.parse(g):{},this.gridster.add_widget(e.render(),c.width,c.height,g.x||1,g.y||1),e.page=this,d&&d(e),this.enabledWidgets[e.widgetName]=e}});b.Item=d,b.List=e,b.Widget=f,b.LinkWidget=g,b.Page=h,a.storage=new c,a.newPage=new h}(window,window.Views),function(a,b,c,d){var e=Backbone.Model.extend({default_icon_url:function(){var a=this.get("icons"),b=_.last(a);return b?b.url:"themes/images/app-icon.png"},launched:function(){var a=["packaged_app","hosted_app"],b=this.get("type");return _.contains(a,b)},toJSON:function(){return{id:this.get("id"),name:this.get("shortName"),icon_url:this.default_icon_url(),launchedApp:this.launched()}}}),f=Backbone.Collection.extend({model:e,comparator:function(a){var b={hosted_app:1,package_app:2};return b[a.get("type")]||3}}),g=c.Item.extend({tagName:"div",className:"application-container",template:$("#widget-app-template").html(),events:{"click .launch-app":"launch"},launch:function(a){var b=$(a.currentTarget).data("app-id");chrome.management.launchApp(b)}}),h=c.List.extend({el:".apps-content",ItemView:g}),i=c.Widget.extend({widgetName:"apps",template:$("#widget-apps-template").html(),events:{"click .apps-icon":"openContent"},initialize:function(){this.appsDisplayed=!1},openContent:function(){return this.appsDisplayed||(this.$el.find(".apps-icon").hide(),this.resize(14,12),this.$el.find(".apps-container").show(),this.appsDisplayed=!0),!1},closeContent:function(){return this.$el.find(".apps-container").hide(),this.resize(d.width,d.height),this.$el.find(".apps-icon").show(),this.appsDisplayed=!1,!1},renderApps:function(){$("#widget-app-template").html();return chrome.management.getAll(function(a){var b=_.map(a,function(a){return new e(a)}),a=new f(b),c=new h(a);c.render()}),this}});b.addWidget(i,d,function(a){a.renderApps()})}(window,window.newPage,window.Views,window.newPage.settings.widgets.apps||{width:3,height:3}),function(a,b,c,d){var e=c.LinkWidget.extend({widgetName:"bookmarks",url:"chrome://bookmarks",template:$("#widget-bookmarks-template").html()});b.addWidget(e,d)}(window,window.newPage,window.Views,window.newPage.settings.widgets.bookmarks||{width:3,height:3}),function(a,b,c,d){var e=Backbone.Model.extend({initialize:function(a){this.date=a},getMonth:function(){var a={0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"};return a[this.date.getMonth().toString()]},toJSON:function(){return{day:this.date.getDate(),month:this.getMonth()}}}),f=c.Widget.extend({widgetName:"calendar",template:$("#widget-calendar-template").html(),getContext:function(){var a=new e(new Date);return a.toJSON()}});b.addWidget(f,d,function(b){a.setInterval(function(){b.render()},6e4)})}(window,window.newPage,window.Views,window.newPage.settings.widgets.calendar||{width:4,height:3}),function(a,b,c,d){var e=Backbone.Model.extend({toJSON:function(){return{url:this.get("url")}}}),f=Backbone.Collection.extend({model:e,sort:function(){return this.models=_.shuffle(this.models),this}}),g=c.Widget.extend({widgetName:"carousel",template:$("#widget-carousel-template").html(),getContext:function(){var a=["widgets/images/bender/001.jpg","widgets/images/bender/002.jpg","widgets/images/bender/003.jpg","widgets/images/bender/004.jpg"],b=_.map(a,function(a){return new e({url:a})}),c=new f(b);return context=_.map(c.sort().models,function(a){return a.toJSON()}),{images:context}}});b.addWidget(g,d,function(a){var b=a.$el.find(".jcarousel");b.jcarousel({wrap:"circular"}),a.$el.click(function(){b.jcarousel("scroll","+=1")})})}(window,window.newPage,window.Views,window.newPage.settings.widgets.carousel||{width:13,height:8}),function(a,b,c,d){var e=Backbone.Model.extend({initialize:function(a){this.time=a},toJSON:function(){return{hours:this.getHours(),minutes:this.getMinutes(),seconds:this.getSeconds(),milliseconds:this.getMilliseconds()}},getHours:function(){return this.getNiceFormat(this.time.getHours())},getMinutes:function(){return this.getNiceFormat(this.time.getMinutes())},getSeconds:function(){return this.getNiceFormat(this.time.getSeconds())},getMilliseconds:function(){return this.getNiceFormat(this.time.getMilliseconds())},getNiceFormat:function(a,b){var b=b||10;return(b>a?"0":"")+a}}),f=c.Widget.extend({widgetName:"clock",template:$("#widget-clock-template").html(),getContext:function(){var a=new e(new Date);return a.toJSON()}});b.addWidget(f,d,function(b){a.setInterval(function(){b.render()})})}(window,window.newPage,window.Views,window.newPage.settings.widgets.clock||{width:6,height:3}),function(a,b,c,d){var e=c.LinkWidget.extend({widgetName:"downloads",url:"chrome://downloads",template:$("#widget-downloads-template").html()});b.addWidget(e,d)}(window,window.newPage,window.Views,window.newPage.settings.widgets.downloads||{width:3,height:3}),function(a,b,c,d){var e=c.LinkWidget.extend({widgetName:"history",url:"chrome://history",template:$("#widget-history-template").html()});b.addWidget(e,d)}(window,window.newPage,window.Views,window.newPage.settings.widgets.history||{width:3,height:3}),function(a,b,c,d){var e=Backbone.Model.extend({initialize:function(){this.main=this.get("main"),this.clous=this.get("clouds"),this.weather=this.get("weather")[0],this.wind=this.get("wind")},iconUrl:function(){var a=this.weather.icon,b=_.sprintf("http://openweathermap.org/img/w/%s.png",a);return b},temperature:function(){var a=this.main.temp-273.15;return a=Math.floor(a),a=a>=0?_.sprintf("+%s",a):_.sprintf("-%s",a)},toJSON:function(){return{title:this.weather.main,description:this.weather.description,temperature:this.temperature(),icon_url:this.iconUrl(),wind:this.wind.speed}}}),f=c.Item.extend({tagName:"div",className:"weather-container",template:$("#widget-weather-day-template").html()}),g=c.Widget.extend({widgetName:"weather",template:$("#widget-weather-template").html(),renderWeather:function(){var a=new XMLHttpRequest,b="http://api.openweathermap.org/data/2.5/weather?q=Minsk,by",c=this;return a.open("GET",b,!0),a.onreadystatechange=function(){if(4==a.readyState){var b=JSON.parse(a.responseText),d=new e(b),g=new f(d);c.$el.html(g.render().$el)}},a.send(),this}});b.addWidget(g,d,function(a){a.renderWeather()})}(window,window.newPage,window.Views,window.newPage.settings.widgets.weather||{width:4,height:3}),function(a){var b=$(".gridster ul");b.on("click",function(b){_.each(a.newPage.enabledWidgets,function(a){a.closeContent(b)})})}(window);